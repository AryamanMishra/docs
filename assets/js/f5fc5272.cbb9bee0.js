"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[616],{3905:(e,a,t)=>{t.d(a,{Zo:()=>d,kt:()=>m});var n=t(7294);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function i(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function o(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?i(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function s(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=n.createContext({}),l=function(e){var a=n.useContext(p),t=a;return e&&(t="function"==typeof e?e(a):o(o({},a),e)),t},d=function(e){var a=l(e.components);return n.createElement(p.Provider,{value:a},e.children)},c={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},u=n.forwardRef((function(e,a){var t=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=l(t),m=r,h=u["".concat(p,".").concat(m)]||u[m]||c[m]||i;return t?n.createElement(h,o(o({ref:a},d),{},{components:t})):n.createElement(h,o({ref:a},d))}));function m(e,a){var t=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=u;var s={};for(var p in a)hasOwnProperty.call(a,p)&&(s[p]=a[p]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var l=2;l<i;l++)o[l]=t[l];return n.createElement.apply(null,o)}return n.createElement.apply(null,t)}u.displayName="MDXCreateElement"},2500:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>p,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var n=t(7462),r=(t(7294),t(3905));const i={sidebar_position:3},o="Apache Spark",s={unversionedId:"integrations/spark",id:"integrations/spark",title:"Apache Spark",description:"This content is out of date and may result in a frustrating experience. Please refer to the instructions in the integration/airflow folder of the OpenLineage GitHub repo for the time being.",source:"@site/docs/integrations/spark.md",sourceDirName:"integrations",slug:"/integrations/spark",permalink:"/docs/integrations/spark",draft:!1,editUrl:"https://github.com/OpenLineage/docs/tree/main/docs/integrations/spark.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Apache Airflow",permalink:"/docs/integrations/airflow"},next:{title:"dbt",permalink:"/docs/integrations/dbt"}},p={},l=[{value:"Collecting Lineage in Spark",id:"collecting-lineage-in-spark",level:2},{value:"How to Use the Integration",id:"how-to-use-the-integration",level:2},{value:"SparkListener",id:"sparklistener",level:3},{value:"spark-submit",id:"spark-submit",level:4},{value:"spark-defaults.conf",id:"spark-defaultsconf",level:4},{value:"Javaagent",id:"javaagent",level:3},{value:"spark-submit",id:"spark-submit-1",level:4},{value:"From Airflow",id:"from-airflow",level:3}],d={toc:l};function c(e){let{components:a,...i}=e;return(0,r.kt)("wrapper",(0,n.Z)({},d,i,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"apache-spark"},"Apache Spark"),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"This content is ",(0,r.kt)("strong",{parentName:"p"},"out of date")," and may result in a frustrating experience. Please refer to the instructions in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/OpenLineage/OpenLineage/tree/main/integration/airflow"},(0,r.kt)("inlineCode",{parentName:"a"},"integration/airflow")," folder of the OpenLineage GitHub repo")," for the time being.")),(0,r.kt)("p",null,"Spark jobs typically run on clusters of machines. A single machine hosts the \"driver\" application,\nwhich constructs a graph of jobs - e.g., reading data from a source, filtering, transforming, and\njoining records, and writing results to some sink- and manages execution of those jobs. Spark's\nfundamental abstraction is the Resilient Distributed Dataset (RDD), which encapsulates distributed\nreads and modifications of records. While RDDs can be used directly, it is far more common to work\nwith Spark Datasets or Dataframes, which is an API that adds explicit schemas for better performance\nand the ability to interact with datasets using SQL. The Dataframe's declarative API enables Spark\nto optimize jobs by analyzing and manipulating an abstract query plan prior to execution."),(0,r.kt)("h2",{id:"collecting-lineage-in-spark"},"Collecting Lineage in Spark"),(0,r.kt)("p",null,"Collecting lineage requires hooking into Spark's ",(0,r.kt)("inlineCode",{parentName:"p"},"ListenerBus")," in the driver application and\ncollecting and analyzing execution events as they happen. Both raw RDD and Dataframe jobs post events\nto the listener bus during execution. These events expose the structure of the job, including the\noptimized query plan, allowing the Spark integration to analyze the job for datasets consumed and\nproduced, including attributes about the storage, such as location in GCS or S3, table names in a\nrelational database or warehouse, such as Redshift or Bigquery, and schemas. In addition to dataset\nand job lineage, Spark SQL jobs also report logical plans, which can be compared across job runs to\ntrack important changes in query plans, which may affect the correctness or speed of a job."),(0,r.kt)("p",null,"A single Spark application may execute multiple jobs. The Spark OpenLineage integration maps one\nSpark job to a single OpenLineage Job. The application will be assigned a Run id at startup and each\njob that executes will report the application's Run id as its parent job run. Thus, an application\nthat reads one or more source datasets, writes an intermediate dataset, then transforms that\nintermediate dataset and writes a final output dataset will report three jobs- the parent application\njob, the initial job that reads the sources and creates the intermediate dataset, and the final job\nthat consumes the intermediate dataset and produces the final output. As an image:\n",(0,r.kt)("img",{alt:"image",src:t(1326).Z,width:"1289",height:"204"})),(0,r.kt)("h2",{id:"how-to-use-the-integration"},"How to Use the Integration"),(0,r.kt)("p",null,"Adding OpenLineage metadata collection to existing Spark jobs was designed to be straightforward\nand unobtrusive to the application. The Spark integration works as either a ",(0,r.kt)("inlineCode",{parentName:"p"},"javaagent")," or as a\n",(0,r.kt)("inlineCode",{parentName:"p"},"SparkListener"),"."),(0,r.kt)("h3",{id:"sparklistener"},"SparkListener"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"SparkListener")," approach is very simple and covers most cases. The listener simply analyzes\nevents, as they are posted by the SparkContext, and extracts job and dataset metadata that are\nexposed by the RDD and Dataframe dependency graphs. Most data sources, such as filesystem sources\n(including S3 and GCS), JDBC backends, and warehouses such as Redshift and Bigquery can be analyzed\nand reported in this way."),(0,r.kt)("h4",{id:"spark-submit"},"spark-submit"),(0,r.kt)("p",null,"The listener can be enabled by adding the following configuration to a ",(0,r.kt)("inlineCode",{parentName:"p"},"spark-submit")," command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'spark-submit --conf "spark.extraListeners=marquez.spark.agent.SparkListener" \\\n    --packages "io.github.marquezproject:marquez-spark:0.15.1" \\\n    --conf "openlineage.host=http://<your_ol_endpoint>" \\\n    --conf "openlineage.namespace=my_job_namespace" \\\n    --class com.mycompany.MySparkApp my_application.jar\n')),(0,r.kt)("p",null,"Additional configuration can be set if applicable"),(0,r.kt)("table",null,(0,r.kt)("tbody",null,(0,r.kt)("tr",null,(0,r.kt)("th",null,"Configuration Key"),(0,r.kt)("th",null,"Description"),(0,r.kt)("th",null,"Default")),(0,r.kt)("tr",null,(0,r.kt)("td",null,"openlineage.parentJobName"),(0,r.kt)("td",null,"The job name of the parent job that triggered this Spark application"),(0,r.kt)("td",null)),(0,r.kt)("tr",null,(0,r.kt)("td",null,"openlineage.parentRunId"),(0,r.kt)("td",null,"The RunId of the parent job Run that triggered this Spark application"),(0,r.kt)("td",null,"\xa0")),(0,r.kt)("tr",null,(0,r.kt)("td",null,"openlineage.apiKey"),(0,r.kt)("td",null,"The API Key used to authenticate with the OpenLineage server that collects events"),(0,r.kt)("td",null,"\xa0")),(0,r.kt)("tr",null,(0,r.kt)("td",null,"openlineage.version"),(0,r.kt)("td",null,"The API version of the OpenLineage specification"),(0,r.kt)("td",null,"1")))),(0,r.kt)("h4",{id:"spark-defaultsconf"},"spark-defaults.conf"),(0,r.kt)("p",null,"Alternatively, the same configuration parameters can be added to the ",(0,r.kt)("inlineCode",{parentName:"p"},"spark-defaults.conf")," file on\ncluster creation. Add the following key/value parameters to the ",(0,r.kt)("inlineCode",{parentName:"p"},"spark-defaults.conf")," file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"spark.jars.packages    io.github.marquezproject:marquez-spark:0.15.1\nspark.extraListeners   marquez.spark.agent.SparkListener\nopenlineage.host       http://<your_ol_endpoint>\nopenlineage.namespace  my_job_namespace\n")),(0,r.kt)("p",null,"The optional keys defined above can also be added here. When the job is submitted, additional or\noverriding configuration values can be supplied. E.g., the ",(0,r.kt)("inlineCode",{parentName:"p"},"openlineage.host")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"openlineage.namespace"),"\ncan be defined in the ",(0,r.kt)("inlineCode",{parentName:"p"},"spark-defaults.conf")," file and the ",(0,r.kt)("inlineCode",{parentName:"p"},"openlineage.parentRunId")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"openlineage.parentJobName"),"\nconfiguration can be supplied when the job is submitted by the parent job."),(0,r.kt)("h3",{id:"javaagent"},"Javaagent"),(0,r.kt)("p",null,"The Javaagent approach is the earliest approach to adding lineage events. It was aimed to support\ninstrumenting Spark code directly by manipulating bytecode at runtime. In the case of Dataframe or\nRDD code that doesn't expose the underlying datasource directly, the javaagent approach will allow\ninjecting bytecode at runtime to expose the required information. This approach requires being able\nto add the ",(0,r.kt)("inlineCode",{parentName:"p"},"marquez-spark")," jar on the driver host and adding the correct JVM startup parameters. This\nmay not be possible, e.g., on a serverless Spark platform, such as AWS Glue."),(0,r.kt)("h4",{id:"spark-submit-1"},"spark-submit"),(0,r.kt)("p",null,"The following configuration must be added to the ",(0,r.kt)("inlineCode",{parentName:"p"},"spark-submit")," command when the job is submitted:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"spark-submit --conf spark.driver.extraJavaOptions=-javaagent:<marquez-spark-jar-location>=http://<your_ol_endpoint>/api/v1/namespaces/<your_job_namespace>/?api_key=<optional_api_key>\n")),(0,r.kt)("p",null,"If a parent job run is triggering the Spark job run, the parent job's name and Run id can be included as such:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"spark-submit --conf spark.driver.extraJavaOptions=-javaagent:<marquez-spark-jar-location>=http://<your_ol_endpoint>/api/v1/namespaces/<your_job_namespace>/jobs/<parent_job_name>/runs/<parent_run_id>?api_key=<optional_api_key>\n")),(0,r.kt)("h3",{id:"from-airflow"},"From Airflow"),(0,r.kt)("p",null,"The same parameters passed to ",(0,r.kt)("inlineCode",{parentName:"p"},"spark-submit")," can be supplied from Airflow and other schedulers. If\nusing the ",(0,r.kt)("a",{parentName:"p",href:"/docs/integrations/airflow"},"marquez-airflow")," integration, each task in the DAG has its own Run id\nwhich can be connected to the Spark job run via the ",(0,r.kt)("inlineCode",{parentName:"p"},"openlineage.parentRunId")," parameter. For example,\nhere is an example of a ",(0,r.kt)("inlineCode",{parentName:"p"},"DataProcPySparkOperator")," that submits a Pyspark application on Dataproc:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'t1 = DataProcPySparkOperator(\n    task_id=job_name,\n    gcp_conn_id=\'google_cloud_default\',\n    project_id=\'project_id\',\n    cluster_name=\'cluster-name\',\n    region=\'us-west1\',\n    main=\'gs://bucket/your-prog.py\',\n    job_name=job_name,\n    dataproc_pyspark_properties={\n      "spark.extraListeners": "marquez.spark.agent.SparkListener",\n      "spark.jars.packages": "io.github.marquezproject:marquez-spark:0.15.+",\n      "openlineage.url": f"{marquez_url}/api/v1/namespaces/{marquez_namespace}/jobs/dump_orders_to_gcs/runs/{{{{task_run_id(run_id, task)}}}}?api_key={api_key}"\n    },\n    dag=dag)\n')),(0,r.kt)("p",null,"The same job can be submitted using the ",(0,r.kt)("inlineCode",{parentName:"p"},"javaagent")," approach:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"t1 = DataProcPySparkOperator(\n    task_id=job_name,\n    gcp_conn_id='google_cloud_default',\n    project_id='project_id',\n    cluster_name='cluster-name',\n    region='us-west1',\n    main='gs://bucket/your-prog.py',\n    job_name=job_name,\n    dataproc_pyspark_properties={\n      'spark.driver.extraJavaOptions':\n        f\"-javaagent:marquez-spark-0.15.0.jar={marquez_url}/api/v1/namespaces/{marquez_namespace}/jobs/dump_orders_to_gcs/runs/{{{{task_run_id(run_id, task)}}}}?api_key={api_key}\"\n    files=\"https://repo1.maven.org/maven2/io/github/marquezproject/marquez-spark/0.15.0/marquez-spark-0.15.0.jar\",\n    dag=dag)\n")))}c.isMDXComponent=!0},1326:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/spark-job-creation.dot-d3fd1094587dcacc0c8a1566dac60ed5.png"}}]);